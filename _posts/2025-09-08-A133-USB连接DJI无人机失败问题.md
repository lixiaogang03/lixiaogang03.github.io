---
layout:     post
title:      A133 USB连接DJI无人机失败问题
subtitle:   DJI neo
date:       2025-09-08
author:     LXG
header-img: img/post-bg-DJI.jpg
catalog: true
tags:
    - DJI
---

## 问题现象

1. 无人机直连A133控制主板时，无法识别为大容量存储设备
2. A133主板接绿联USB hub再接无人机时可以识别为大容量存储设备

![dji_usb_hub](/images/dji/dji_usb_hub.png)

## 直连日志

```yaml

# 检测到高速（High-Speed, USB 2.0）设备连接到 Allwinner A133 的 EHCI 控制器上
# 设备成功上电并开始握手，但不代表已经完全枚举成功
09-08 16:28:04.321356[ 6322.413719] sunxi-ehci 5101000.ehci0-controller: ehci_irq: highspeed device connect

# Linux 为连接的 USB 设备分配了设备号 2
# EHCI 驱动已经识别设备并准备枚举
09-08 16:28:04.543229[ 6322.632529] usb 3-1: new high-speed USB device number 2 using sunxi-ehci

# USB 子系统识别该设备为 USB 大容量存储设备（U盘/存储卡）
# 设备已经可以作为块设备（block device）使用
09-08 16:28:04.689879[ 6322.780072] usb-storage 3-1:1.2: USB Mass Storage device detected

# 为该 USB 存储设备创建一个 SCSI 主机实例 host0
# Linux 通过 usb-storage 驱动模拟 SCSI 设备以访问文件系统
09-08 16:28:04.693187[ 6322.784509] scsi host0: usb-storage 3-1:1.2

# SCSI 设备枚举完成，识别为 Direct-Access（可寻址块存储设备）
# 说明设备内部存储（可能是 TF 卡或 eMMC）已被识别
09-08 16:28:05.696530[ 6323.787832] scsi 0:0:0:0: Direct-Access     Linux    File-Stor Gadget 0504 PQ: 0 ANSI: 2

# 存储设备容量约 23.7 GB
# 驱动已经读取到逻辑块数，设备容量正常
09-08 16:28:05.705844[ 6323.796188] sd 0:0:0:0: [sda] 46350296 512-byte logical blocks: (23.7 GB/22.1 GiB)

# 设备未写保护，可写入数据
09-08 16:28:05.706002[ 6323.796904] sd 0:0:0:0: [sda] Write Protect is off

# 读取 SCSI Mode Sense 信息，用于获取设备特性
09-08 16:28:05.706057[ 6323.796912] sd 0:0:0:0: [sda] Mode Sense: 0f 00 00 00

# 设备启用读写缓存，但不支持高级命令（DPO/FUA）
09-08 16:28:05.706108[ 6323.797643] sd 0:0:0:0: [sda] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA

# 块设备已成功挂载到内核，可作为 /dev/sda 使用
09-08 16:28:05.719937[ 6323.809048] sda:
09-08 16:28:05.723203[ 6323.812790] sd 0:0:0:0: [sda] Attached SCSI removable disk

# Android 使用 sdcardfs 将块设备挂载到 /mnt/media_rw/61C8-D15B，并配置访问权限
09-08 16:28:05.973218[ 6324.062496] sdcardfs version 2.0
09-08 16:28:05.973402[ 6324.062511] sdcardfs: dev_name -> /mnt/media_rw/61C8-D15B
09-08 16:28:05.973448[ 6324.062516] sdcardfs: options -> fsuid=1023,fsgid=1023,mask=6,userid=0,gid=1015,reserved_mb=100
09-08 16:28:05.973491[ 6324.062524] sdcardfs: mnt -> ffffffc02cd8b6e0
# sdcardfs 成功挂载，但挂载类型是 fuseblk，说明可能是 exFAT 文件系统，需要内核支持
09-08 16:28:05.973534[ 6324.062606] sdcardfs: mounted on top of /mnt/media_rw/61C8-D15B type fuseblk
09-08 16:28:05.973577[ 6324.063769] Remount options were mask=18,gid=9997 for vfsmnt ffffffc0439c5de0.
09-08 16:28:05.973614[ 6324.063782] sdcardfs : options - debug:1
09-08 16:28:05.973656[ 6324.063787] sdcardfs : options - gid:9997
09-08 16:28:05.973698[ 6324.063791] sdcardfs : options - mask:18
09-08 16:28:05.973740[ 6324.064510] Remount options were mask=18,gid=9997 for vfsmnt ffffffc053d6c3a0.
09-08 16:28:05.973777[ 6324.064518] sdcardfs : options - debug:1
09-08 16:28:05.973818[ 6324.064522] sdcardfs : options - gid:9997
09-08 16:28:05.973859[ 6324.064525] sdcardfs : options - mask:18
09-08 16:28:05.973902[ 6324.065257] Remount options were mask=7,gid=9997 for vfsmnt ffffffc053c138a0.
09-08 16:28:05.973939[ 6324.065264] sdcardfs : options - debug:1
09-08 16:28:05.973981[ 6324.065268] sdcardfs : options - gid:9997
09-08 16:28:05.974022[ 6324.065272] sdcardfs : options - mask:7

# USB 高速设备断开连接
# 可能是 USB PHY 信号质量差、电源不足或线材问题，导致设备在短时间内掉线
09-08 16:28:07.553738[ 6325.646092] sunxi-ehci 5101000.ehci0-controller: ehci_irq: highspeed device disconnect
09-08 16:28:07.556591[ 6325.646769] usb 3-1: USB disconnect, device number 2

# 块设备尝试同步缓存失败
# 掉线导致 SCSI cache flush 失败。hostbyte=0x01 表示主机错误，通常与硬件连接不稳定相关
09-08 16:28:07.593213[ 6325.682724] sd 0:0:0:0: [sda] Synchronizing SCSI cache
09-08 16:28:07.593389[ 6325.682896] sd 0:0:0:0: [sda] Synchronize Cache(10) failed: Result: hostbyte=0x01 driverbyte=0x00

```

## 可能的原因分析

**信号完整性改善**

* Hub 内部布线、端口缓冲芯片对 USB 信号做了 再驱动（re-driver）
* 直连线可能导致 高速信号衰减或反射，Hub 相当于加了一个信号“缓冲器”
* 高速设备枚举时，如果信号质量不好，就容易掉线

**总线电流瞬时冲击分散**

* Hub 虽然无源，但内部做了 电流分配和稳压电路。
* 当无人机刚上电或块设备初始化时，瞬间拉电流导致直连口电压下降。
* 通过 Hub 后，多个端口共享总线电流，瞬时冲击可能稍微缓解，掉线概率降低。

**USB 枚举顺序和延时改变**

* Hub 会引入 几微秒到几毫秒的延迟。
* 对一些对枚举时序敏感的设备（如无人机内置 USB 存储）有意外正面作用。
* 直连时可能枚举太快，设备还没准备好就被 Host 轮询，导致掉线。

**表格总结**

| 对比项        | 直连 A133 → 无人机              | A133 → Hub → 无人机 | 说明                         |
| ---------- | -------------------------- | ---------------- | -------------------------- |
| **USB 枚举** | 成功，但几秒后掉线                  | 成功且稳定            | Hub 引入微延迟，设备初始化更充分         |
| **信号完整性**  | 受 PCB Trace &连接器寄生影响，易短时抖动 | Hub 内部缓冲/再驱动改善信号 | 高速 USB 对阻抗匹配敏感             |
| **供电稳定性**  | 瞬时拉电流可能导致电压下降 → 掉线         | Hub 分流/缓冲瞬时电流    | Hub 起到电流缓冲作用，即使无源也有寄生电容    |
| **掉线现象**   | 几秒内断开，SCSI Cache Flush 失败  | 稳定，无掉线           | 主机错误 hostbyte=0x01 指向物理层问题 |
| **解决方式**   | 改进 PCB 电源、增加延时或使用高性能端口     | 可直接使用            | Hub 是快速、可靠的方案              |
| **适用性**    | 对敏感设备不稳定                   | 高速存储设备稳定识别       | 对无人机存储、摄像头等高速设备尤其明显        |

## 需求

通过 USB 集线器同时接 5 台 DJI Neo 飞机到一台安卓主机，并能够访问任意一台的存储图片

```markdown

              ┌───────────────────────────┐
              │       安卓主机 (USB Host) │
              │ ┌─────────────────────┐  │
              │ │ USB 控制器 xHCI/ EHCI │
              │ └─────────┬───────────┘  │
              └───────────┼─────────────┘
                          │
                          │ 高速信号 + 电源
                          │
                 ┌────────┴─────────┐
                 │       有源 USB Hub │
                 │   (每端口 ≥1A 电流)│
                 └─────┬───┬───┬───┬───┘
                       │   │   │   │
          ┌────────────┘   │   │   │
          │                │   │   │
     ┌────┴────┐      ┌────┴────┐│  │
     │无人机1   │      │无人机2   ││  │
     │存储/图片 │      │存储/图片 ││  │
     └─────────┘      └─────────┘│  │
                                   │
       ┌─────────┐     ┌─────────┐ │
       │无人机3   │     │无人机4   │ │
       │存储/图片 │     │存储/图片 │ │
       └─────────┘     └─────────┘ │
                                     │
                               ┌─────┴─────┐
                               │无人机5     │
                               │存储/图片   │
                               └───────────┘

```

**即便使用了有源的hub也不一定能支持5路**

| 问题       | Hub 是否能解决                      |
| -------- | ------------------------------ |
| 电流不足导致掉线 | ✅ 可缓冲电流，每端口独立供电 ≥1A            |
| 信号抖动     | ✅ 优质 Hub 会改善信号完整性              |
| 带宽限制     | ❌ Hub 不能增加主控 USB 带宽，单控制器仍共享总带宽 |
| 同时枚举失败   | ❌ 仍受限于主控处理能力                   |

**硬件条件**

| 条件             | 说明                                                                                                               |
| -------------- | ---------------------------------------------------------------------------------------------------------------- |
| **USB 控制器数量**  | 安卓主机必须有 **足够的高速 USB 控制器**。如果只有一个 EHCI/xHCI 控制器，5 台高速设备会共享带宽和电流，可能掉线。理想是 **每 2 台无人机分配一个控制器** 或者使用带独立通道的 xHCI 控制器。 |
| **USB Hub 类型** | **有源 Hub**（带独立电源）必需，否则 5 台无人机同时拉电可能导致电压下降和掉线。Hub 的每个端口最好能提供 1A 以上电流。                                             |
| **线材与信号完整性**   | 高速 USB 线短、屏蔽良好，连接器质量高，以减少信号抖动和掉线。                                                                                |

**软件条件**

| 条件              | 说明                                                                                       |
| --------------- | ---------------------------------------------------------------------------------------- |
| **USB Host 模式** | 安卓主机必须支持 USB Host（OTG）模式，并且有 xHCI 控制器驱动，支持多设备同时挂载。                                       |
| **文件系统访问**      | 每台无人机的存储必须被识别为 **USB Mass Storage（U盘模式）** 或者 MTP 模式。安卓系统才能通过 `/storage` 或 `/mnt/usb` 访问。 |
| **多设备枚举**       | 安卓 USB Host API 可以同时管理多个 USB 设备，但应用需要：                                                   |

## 集线器选型

[UGREEN 7-Port USB 3.0 Hub](https://www.lulian.cn/product/201-cn.html)









