---
layout:     post
title:      BY USB 偶现掉线日志分析
subtitle:   A133
date:       2025-12-18
author:     LXG
header-img: img/post-bg-xiaomi.jpg
catalog: true
tags:
    - A133
---

## 现象

重复启动设备，偶现一次无法识别到USB身份证模块

## 内核正常USB拔插日志

```bash

[  682.060671] usb 1-1.2: USB disconnect, device number 3
[  683.698086] usb 1-1.2: new full-speed USB device number 4 using sunxi-ehci
[  683.794637] usb 1-1.2: device descriptor read/64, error -32


```

## 内核异常日志

```bash

12-16 18:21:25.860270[   19.387334] \x0ainsmod_host_driver\x0a
# 使能 EHCI（USB2.0 高速）控制器
12-16 18:21:25.860458[   19.387347] [ehci0-controller]: sunxi_usb_enable_ehci
12-16 18:21:25.860521[   19.387359] [sunxi-ehci0]: probe, pdev->name: 5101000.ehci0-controller, sunxi_ehci: 0xffffff800960aa58, 0x:ffffff80097c4000, irq_no:166
12-16 18:21:25.860581[   19.389818] sunxi-ehci 5101000.ehci0-controller: SW USB2.0 'Enhanced' Host Controller (EHCI) Driver
12-16 18:21:25.860640[   19.390456] sunxi-ehci 5101000.ehci0-controller: new USB bus registered, assigned bus number 3
12-16 18:21:25.863487[   19.393111] sunxi-ehci 5101000.ehci0-controller: irq 358, io mem 0x00000002
12-16 18:21:25.877041[   19.403975] sunxi-ehci 5101000.ehci0-controller: USB 0.0 started, EHCI 1.00

# 检测到 高速 USB 设备接入（High-Speed）
12-16 18:21:25.877209[   19.403989] sunxi-ehci 5101000.ehci0-controller: ehci_irq: highspeed device connect
12-16 18:21:25.877270[   19.405770] hub 3-0:1.0: USB hub found
12-16 18:21:25.877327[   19.406247] hub 3-0:1.0: 1 port detected

# 使能 OHCI（USB1.1 全速）控制器
12-16 18:21:25.877385[   19.406666] [ohci0-controller]: sunxi_usb_enable_ohci
12-16 18:21:25.877442[   19.406674] [sunxi-ohci0]: probe, pdev->name: 5101000.ohci0-controller, sunxi_ohci: 0xffffff800960b4f0
12-16 18:21:25.877500[   19.407046] sunxi-ohci 5101000.ohci0-controller: SW USB2.0 'Open' Host Controller (OHCI) Driver
12-16 18:21:25.880137[   19.408699] sunxi-ohci 5101000.ohci0-controller: new USB bus registered, assigned bus number 4
12-16 18:21:25.880316[   19.408791] sunxi-ohci 5101000.ohci0-controller: irq 359, io mem 0xffffffc03e0f8000
12-16 18:21:25.940616[   19.469431] hub 4-0:1.0: USB hub found
12-16 18:21:25.940780[   19.469469] hub 4-0:1.0: 1 port detected

# 关键异常：高速枚举失败 → 设备掉线
12-16 18:21:26.136911[   19.667395] sunxi-ehci 5101000.ehci0-controller: ehci_irq: highspeed device disconnect

# 设备 以 Full-Speed（USB1.1）重新接入
# Host 在做兼容性回退
12-16 18:21:26.460186[   19.987402] usb 4-1: new full-speed USB device number 2 using sunxi-ohci

# 致命错误：USB 描述符非法（根因）
12-16 18:21:26.616832[   20.145752] usb 4-1: config index 0 descriptor too short (expected 32, got 9)
12-16 18:21:26.617015[   20.145767] usb 4-1: config 1 has 0 interfaces, different from the descriptor's value: 1

```

**日志分析**

1. USB Host（EHCI / OHCI）初始化完全正常
2. USB 设备尝试以 High-Speed 枚举，但迅速断开
3. Host 回退到 Full-Speed 重新枚举
4. 设备返回了非法的 Configuration Descriptor（长度不足、接口数量不一致）
5. 枚举失败，后续 Android Framework 解析 Descriptor 时必然异常


**sunxi_usb_enable_ohci降级到了sunxi-ohci**

| 原因               | 说明                                     |
| ---------------- | -------------------------------------- |
| PHY 初始化失败        | 高速 PHY 可能没上电或复位失败                      |
| 电流不足             | EHCI 端口无法稳定供电，高速设备无法枚举                 |
| 硬件兼容性            | 某些 USB 设备在 EHCI 下握手失败                  |
| 内核驱动 fallback 机制 | EHCI 初始化失败 → USB core 尝试 OHCI，保证低速设备能用 |


## android 日志

```bash

12-16 18:21:26.621237  2027  2226 I UsbDescriptorParser: Unknown Descriptor len: 0 type:0x0
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: Exception allocating USB descriptor.
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: java.lang.IllegalArgumentException
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.descriptors.UsbDescriptor.<init>(UsbDescriptor.java:140)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.descriptors.UsbUnknown.<init>(UsbUnknown.java:26)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.descriptors.UsbDescriptorParser.allocDescriptor(UsbDescriptorParser.java:201)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.descriptors.UsbDescriptorParser.parseDescriptors(UsbDescriptorParser.java:227)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.descriptors.UsbDescriptorParser.<init>(UsbDescriptorParser.java:64)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.UsbHostManager.usbDeviceAdded(UsbHostManager.java:372)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.UsbHostManager.monitorUsbHostBus(Native Method)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.UsbHostManager.lambda$XT3F5aQci4H6VWSBYBQQNSzpnvs(Unknown Source:0)
12-16 18:21:26.624328  2027  2226 E UsbDescriptorParser: 	at com.android.server.usb.-$$Lambda$UsbHostMa

```

**日志分析**

Android 在解析 USB 设备上报的 Descriptor 时，收到了一个“非法的 USB 描述符（bLength=0）”，直接违反 USB 规范，因此 framework 直接抛异常

## AI 分析

```markdown

【硬件】
USB 设备上电 / 复位
    ↓
【Kernel】
USB Host Controller 枚举设备
  ├─ 发 GET_DESCRIPTOR
  ├─ 收到 descriptor 数据（⚠️ 这里已可能异常）
  ├─ 生成 usb_device / uevent
    ↓
【Framework】
UsbHostManager 收到 uevent
  └─ UsbDescriptorParser 解析 descriptor
      └─ 抛出 IllegalArgumentException

```

**分析结论**

* ❌ 不是 Framework bug
* ❌ 不是 App bug
* ⚠️ Framework 只是“放大器”
✅ 问题根因 100% 在：
   * USB 设备端上电 / 复位时序
   * USB HUB / PHY
   * Host Controller 在设备未 ready 时读取 descriptor

核心问题实际上是 EHCI 控制器无法正确初始化高速设备，所以内核 fallback 到 OHCI。OHCI 的低速/全速端口在枚举高速设备时往往会出现 descriptor 不完整、字段异常等情况，才导致 Framework 抛异常
















