---
layout:     post
title:      RK3576 åŒä»¥å¤ªç½‘
subtitle:   android 14
date:       2025-07-16
author:     LXG
header-img: img/post-bg-sky.jpg
catalog: true
tags:
    - rk3576
---

[é…ç½®å†…éƒ¨ä»¥å¤ªç½‘](https://source.android.com/docs/automotive/connectivity/ethernet-manage?hl=zh-cn)

## Android 12 å¯¹æ¯” 14 åœ¨å¤šä»¥å¤ªç½‘å·®å¼‚

Android 14 ç¡®å®åœ¨æ¡†æ¶å±‚é¢æ›´å¥½åœ°å¤„ç†äº†å¤šä¸ªä»¥å¤ªç½‘æ¥å£çš„å¹¶è¡Œå·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨ Automotive OS çš„æ¨åŠ¨ä¸‹ï¼Œå¯¹å¤šç½‘å¡çš„æ”¯æŒæˆä¸ºäº†æ ¸å¿ƒéœ€æ±‚ã€‚

| é¡¹ç›®                           | Android 12                                   | Android 14                                                |
|--------------------------------|----------------------------------------------|------------------------------------------------------------|
| ğŸŒ å¤šä»¥å¤ªç½‘æ¥å£æ”¯æŒ            | âš ï¸ åˆæ­¥æ”¯æŒï¼Œä»… eth0 ç¨³å®šï¼›eth1 éœ€å®šåˆ¶      | âœ… åŸç”Ÿæ”¯æŒå¤šæ¥å£ï¼Œeth0/eth1 å¹¶è¡Œ                          |
| âš™ï¸ æ¥å£è¯†åˆ«æœºåˆ¶                | ä»…æ”¯æŒ `config_ethernet_iface_regex`         | âœ… æ”¯æŒ `config_ethernet_interfaces` ç²¾ç¡®æ§åˆ¶              |
| ğŸ”Œ æ¥å£æ³¨å†Œæœºåˆ¶                | é»˜è®¤åªæ³¨å†Œç¬¬ä¸€ä¸ªæ¥å£                         | âœ… æ¯ä¸ªæ¥å£éƒ½é€šè¿‡ `NetworkOffer` æ³¨å†Œ                      |
| ğŸ“¶ NetworkAgent æ”¯æŒ           | ä»… eth0 è¢«æ³¨å†Œä¸º NetworkAgent               | âœ… eth0 å’Œ eth1 å‡æ³¨å†Œä¸ºç‹¬ç«‹ NetworkAgent                  |
| ğŸ“Š ç½‘ç»œèƒ½åŠ›åˆ¤å®š                | å›ºå®šèƒ½åŠ›é›†åˆï¼Œä¼˜å…ˆçº§ä¸å¯æ§                  | âœ… å¯é…ç½®èƒ½åŠ›ï¼ˆå¦‚ NOT_METEREDï¼‰ä»¥è°ƒæ•´ä¼˜å…ˆçº§               |
| ğŸ“ˆ ç½‘ç»œä¼˜å…ˆçº§æ§åˆ¶              | âŒ å›ºå®šä¼˜å…ˆçº§é¡ºåº                            | âœ… å¯é€šè¿‡ `persist.net.preferred.transports.order` é…ç½®    |
| ğŸ”„ Failover è‡ªåŠ¨åˆ‡æ¢           | âŒ æ— æ³•è‡ªåŠ¨åˆ‡æ¢                              | âœ… æ”¯æŒç½‘ç»œæ–­çº¿è‡ªåŠ¨åˆ‡æ¢                                   |
| ğŸ” è·¯ç”±ç¨³å®šæ€§ä¸å¤šç½‘æ”¯æŒ        | âŒ å¤šæ¥å£è·¯ç”±æ˜“å†²çª                          | âœ… netd æ·»åŠ ä½ä¼˜å…ˆçº§ rule é¿å…è·¯ç”±ä¸¢å¤±                    |
| ğŸ§  å¸¸é©»è¿æ¥ç­–ç•¥                | âŒ æ— æœºåˆ¶                                     | âœ… æ”¯æŒ `ethernet_always_requested` è®¾ç½®                   |
| ğŸ› ï¸ è®¾ç½®å¯æ§æ€§                 | ä»…å¯é€šè¿‡ä¿®æ”¹æºç å®ç°                        | âœ… å¯é€šè¿‡ adb settings å’Œ SystemProperties æ§åˆ¶             |
| ğŸš— Automotive å¤šåŸŸç½‘ç»œæ”¯æŒ     | âŒ æ— ç°æˆæ”¯æŒ                                | âœ… ä¸ Automotive æ¡†æ¶é›†æˆï¼Œæ”¯æŒåŸŸåˆ†ç¦»ï¼ˆå¦‚ IVI/TCUï¼‰         |
| ğŸ’¡ Overlay çµæ´»æ€§              | é…ç½®ç‚¹å°‘ï¼Œéœ€æ”¹ framework                     | âœ… æ”¯æŒå¤šä¸ª config_xxxï¼Œä¾¿äºäº§å“å·®å¼‚åŒ–                     |

## android 14 æºç 

rk3576_android_14/packages/modules/Connectivity/service-t/src/com/android/server/ethernet

```bash

.
â”œâ”€â”€ EthernetCallback.java
â”œâ”€â”€ EthernetConfigStore.java
â”œâ”€â”€ EthernetNetworkAgent.java
â”œâ”€â”€ EthernetNetworkFactory.java
â”œâ”€â”€ EthernetServiceImpl.java
â”œâ”€â”€ EthernetService.java
â””â”€â”€ EthernetTracker.java

```

## è¡¥ä¸å®ç°åŸç†

1. Kernelï¼šeth1 æ¥å£ç”±é©±åŠ¨å±‚åˆ›å»ºï¼Œå¦‚ USB ç½‘å¡æˆ– MAC1 å¯ç”¨ï¼›
2. EthernetTrackerï¼šç³»ç»Ÿç›‘æµ‹åˆ° eth1 æ¥å£ä¸Šçº¿ï¼Œè§¦å‘æ³¨å†Œæµç¨‹ï¼›
3. EthernetNetworkFactoryï¼šé€šè¿‡ registerNetworkOffer() æ³¨å†Œ eth1 ç½‘ç»œèƒ½åŠ›ï¼›
4. ConnectivityServiceï¼šæ¥å— NetworkAgent æ³¨å†Œï¼Œæ„å»º NetworkAgentInfo å®ä¾‹ï¼›
5. NetworkAgentInfoï¼šè¡¨ç¤º eth1 æˆä¸ºç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ´»è·ƒç½‘ç»œï¼›
6. NetworkRankerï¼šç³»ç»Ÿæ ¹æ®ä½ é…ç½®çš„ä¼˜å…ˆçº§ï¼ˆå¦‚ Ethernet > WiFiï¼‰å†³å®š eth1 æ˜¯å¦ä¸ºé»˜è®¤ï¼›
7. RouteController (netd)ï¼šæ·»åŠ è·¯ç”±è§„åˆ™ï¼Œé˜²æ­¢ eth1 çš„ç½‘å…³ä¸¢å¤±æˆ–è·¯ç”±å†²çªã€‚

### eth0 ä¸ eth1 å¹¶å­˜æ—¶çš„ç³»ç»Ÿè·¯ç”±é€‰æ‹©æµç¨‹å›¾

```mermaid

flowchart TD
    A[eth0 æ¥å£ä¸Šçº¿] --> B[EthernetTracker æ³¨å†Œ eth0]
    C[eth1 æ¥å£ä¸Šçº¿] --> D[EthernetTracker æ³¨å†Œ eth1]

    B --> E[EthernetNetworkFactory æ³¨å†Œ eth0 NetworkOffer]
    D --> F[EthernetNetworkFactory æ³¨å†Œ eth1 NetworkOfferï¼ˆé™æƒï¼‰]

    E --> G[ConnectivityService æ³¨å†Œ eth0 NetworkAgent]
    F --> H[ConnectivityService æ³¨å†Œ eth1 NetworkAgent]

    G --> I[NetworkCapabilities: eth0\nNOT_METERED, INTERNET]
    H --> J[NetworkCapabilities: eth1\nMETERED, INTERNET]

    I --> K[NetworkRanker è·å–ä¼˜å…ˆçº§]
    J --> K

    K --> L{ä¼˜å…ˆçº§æ¯”è¾ƒ}
    L -- eth0 ä¼˜å…ˆ --> M[eth0 è®¾ç½®ä¸ºé»˜è®¤ç½‘ç»œ]
    L -- eth1 ä¼˜å…ˆ --> N[eth1 è®¾ç½®ä¸ºé»˜è®¤ç½‘ç»œ]

    M --> O[netd è®¾ç½®é»˜è®¤è·¯ç”± via eth0]
    N --> P[netd è®¾ç½®é»˜è®¤è·¯ç”± via eth1]

    G --> Q[netd æ·»åŠ  eth0 ç›´è¿è·¯ç”±]
    H --> R[netd æ·»åŠ  eth1 ç›´è¿è·¯ç”±]


```

* eth0 ä¸€èˆ¬å…·æœ‰æ›´é«˜ä¼˜å…ˆçº§ï¼Œå› ä¸ºå®ƒå¸¦æœ‰ NOT_METEREDï¼Œç³»ç»Ÿè®¤ä¸ºå®ƒæ˜¯å…è´¹/ä¸»é“¾è·¯ï¼›
* eth1 è¢«è¡¥ä¸åˆ»æ„é™çº§ï¼ˆå»æ‰ NOT_METEREDï¼‰ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆé€‰æ‹© eth0 ä¸ºé»˜è®¤ï¼›
* å³ä¾¿å¦‚æ­¤ï¼Œeth1 ä»æ³¨å†Œä¸º NetworkAgentï¼Œå¯ç”¨äº failoverã€æˆ–ç‰¹å®šè¯·æ±‚ï¼›
* netd ä¼šä¸ºä¸¤ä¸ªæ¥å£éƒ½æ·»åŠ  addDirectlyConnectedRuleï¼Œé¿å…è·¯ç”±å†²çªæˆ–ä¸¢å¤±ã€‚

#### EthernetNetworkFactory.java

åœ¨æ³¨å†Œ NetworkOffer æ—¶ï¼Œå¦‚æœæ¥å£åæ˜¯ eth1ï¼Œå°±é™æƒå¤„ç†, è®©ç³»ç»Ÿè¯†åˆ« eth1 æ˜¯æ¬¡è¦ç½‘ç»œï¼Œä¸æŠ¢å é»˜è®¤è·¯ç”±ï¼›ä½†åˆæ³¨å†Œä¸ºå¯ç”¨ç½‘ç»œ

```java

        private void registerNetworkOffer() {
            // If mNetworkOfferCallback is already set, it should be reused to update the existing
            // offer.
            if (mNetworkOfferCallback == null) {
                mNetworkOfferCallback = new EthernetNetworkOfferCallback();
            }

            //lixiaogang add start
            if(name != null && name.equals("eth1")) {
                //mCapabilities.removeCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
                mCapabilities.removeCapability(NetworkCapabilities.NET_CAPABILITY_NOT_METERED);
                //mCapabilities.removeCapability(NetworkCapabilities.NET_CAPABILITY_NOT_VPN);
                Log.d(TAG, "hcq mCapabilities: " + mCapabilities);
            }
            //lixiaogang add end

            mNetworkProvider.registerNetworkOffer(getNetworkScore(),
                    new NetworkCapabilities(mCapabilities), cmd -> mHandler.post(cmd),
                    mNetworkOfferCallback);
        }

```

#### ConnectivityService.java

å¼ºåˆ¶æ³¨å†Œå¹¶æ¿€æ´»ä»¥å¤ªç½‘ eth1 çš„è¿æ¥è¯·æ±‚

```java

    private void handleConfigureAlwaysOnNetworks() {
        handleAlwaysOnNetworkRequest(mDefaultMobileDataRequest,
                ConnectivitySettingsManager.MOBILE_DATA_ALWAYS_ON, true /* defaultValue */);
        //modify defaultValue to true by lixiaogang
        handleAlwaysOnNetworkRequest(mDefaultWifiRequest,
                ConnectivitySettingsManager.WIFI_ALWAYS_REQUESTED, true /* defaultValue */);
        final boolean vehicleAlwaysRequested = mResources.get().getBoolean(
                R.bool.config_vehicleInternalNetworkAlwaysRequested);
        handleAlwaysOnNetworkRequest(mDefaultVehicleRequest, vehicleAlwaysRequested);

        //lixiaogang add start
        handleAlwaysOnNetworkRequest(mDefaultEthernetRequest,
                ConnectivitySettingsManager.ETHERNET_ALWAYS_REQUESTED, true /* defaultValue */);

        handleAlwaysOnNetworkRequest(mDefaultEthernetRequest,
                ConnectivitySettingsManager.BLUETOOTH_ALWAYS_REQUESTED, true /* defaultValue */);
        //lixiaogang add end
    }

    // æ„å›¾ï¼šé¿å…ç³»ç»Ÿä¸»åŠ¨æ–­å¼€ eth ç½‘ç»œè¿æ¥ï¼ˆå°¤å…¶æ˜¯ eth1ï¼‰
    private void teardownUnneededNetwork(NetworkAgentInfo nai) {
        if (nai.numRequestNetworkRequests() != 0) {
            for (int i = 0; i < nai.numNetworkRequests(); i++) {
                NetworkRequest nr = nai.requestAt(i);
                // Ignore listening and track default requests.
                if (!nr.isRequest()) continue;
                loge("Dead network still had at least " + nr);
                break;
            }
        }
        // delete by lixiaogang start
        // nai.disconnect();
        // delete by lixiaogang end
    }

```

#### RouteController.cpp

æ³¨å†Œä¸€æ¡ä½ä¼˜å…ˆçº§ IP ruleï¼Œç”¨äºæŸ¥æ‰¾ä¸»è·¯ç”±è¡¨ä¸­ç›´è¿ç½‘å…³åœ°å€ï¼Œé¿å…å¤šä¸ªæ¥å£å­˜åœ¨æ—¶è·¯ç”±å†²çªã€‚

```cpp

constexpr int32_t RULE_PRIORITY_DIRECTLY_CONNECTED                = 9999;


int RouteController::Init(unsigned localNetId) {
    if (int ret = flushRules()) {
        return ret;
    }
    if (int ret = addLegacyRouteRules()) {
        return ret;
    }
    if (int ret = addLocalNetworkRules(localNetId)) {
        return ret;
    }
    //lixiaogang add start
    if (int ret = addDirectlyConnectedRule()) {
       return ret;
    }
    //lixiaogang add end
    if (int ret = addUnreachableRule()) {
        return ret;
    }
    // Don't complain if we can't add the dummy network, since not all devices support it.
    configureDummyNetwork();

    updateTableNamesFile();
    return 0;
}

```
















