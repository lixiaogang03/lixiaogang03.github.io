---
layout:     post
title:      AI 对话机器人技术栈
subtitle:   AI
date:       2025-11-17
author:     LXG
header-img: img/google_android.jpg
catalog: true
tags:
    - AI
---

[EmpathyEar](https://github.com/scofield7419/EmpathyEar)

## 架构图

```swift

┌──────────────────────────────────────────────┐
│                  用户（孩子）                 │
│        说话 → 麦克风 → 语音输入               │
└──────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────┐
│         语音采集模块（Android AudioRecord）   │
│  - 降噪/回声消除/端点检测（VAD）              │
└──────────────────────────────────────────────┘
                            │ PCM音频流
                            ▼
┌──────────────────────────────────────────────┐
│      科大讯飞 SDK（离线/在线语音识别 ASR）     │
│  - 把语音 → 文本                              │
└──────────────────────────────────────────────┘
                            │ 文本
                            ▼
┌──────────────────────────────────────────────┐
│               对话管理模块（核心）             │
│  - 调用云端大模型（如 讯飞星火 2.0）           │
│  - 或者使用本地轻量模型（如 ChatGLM-mini）     │
│  - 意图识别                                    │
│  - 情绪判断（决定玩具的表情）                  │
│  - 状态管理（上下文记忆）                      │
└──────────────────────────────────────────────┘
                            │ 文本 + 情绪值
                            ▼
┌──────────────────────────────────────────────┐
│           表情控制模块（Emotion Engine）       │
│  - 表情标签：开心/疑惑/思考/生气/睡眠…         │
│  - 对应动画文件：Lottie / GIF / MP4 /帧动画    │
│  - 输出给 Android UI 层                        │
└──────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────┐
│                  安卓 UI 层                    │
│   - SurfaceView / TextureView 播放动画         │
│   - 显示表情                                   │
└──────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────┐
│                TTS 合成（讯飞 TTS）            │
│   - 文本 → 声音                               │
│   - 可配置音色、情绪、语速                     │
└──────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────┐
│           扬声器播放（AudioTrack）             │
│     → 小朋友听到玩具的回答                     │
└──────────────────────────────────────────────┘

```

## 技术栈

| 模块                | 具体功能          | 使用技术                                  | 可选替代方案                             |
| ----------------- | ------------- | ------------------------------------- | ---------------------------------- |
| **音频采集**          | 麦克风录音、实时语音流   | AudioRecord、OpenSL ES、AEC 回声消除、降噪（NS） | SpeexDSP、WebRTC 音频处理               |
| **唤醒词**（可选）       | 离线唤醒“你好小宝”等   | 科大讯飞离线唤醒、思必驰 DuerOS、Snowboy（停更但可用）    | Picovoice Porcupine                |
| **ASR 语音识别**      | 语音转文字         | **科大讯飞 ASR SDK**、Google Speech（需梯子）   | Whisper（本地版，需高性能 SOC）              |
| **对话引擎（大模型）**     | 聊天对话、情绪提取     | 星火大模型、ChatGPT API、GLM API             | 本地模型：Qwen2.5 1.5B、RWKV、MNN-LLM     |
| **意图理解（NLU）**     | 识别需求：讲故事、问天气等 | 自定义规则 + BERT 分类、小模型 NLU               | ChatGPT 直接解析                       |
| **对话管理（DM）**      | 上下文、状态机、角色人格  | 自研管理器（Kotlin）、Rasa（偏重）                | LLM function-call                  |
| **TTS 语音合成**      | 文本 → 玩具语音     | **科大讯飞 TTS**、火山 TTS、微软 TTS            | 离线 TTS（Piper / VITS）               |
| **音频播放**          | 播放合成语音        | AudioTrack、MediaPlayer                | OpenSL ES                          |
| **表情检测 / 情绪引擎**   | 将对话内容映射到表情    | NLP 情绪分析模型、关键词规则、LLM 输出情绪标签           | 自研分类器（SVM / TinyBERT）              |
| **表情动画引擎**        | 控制屏幕显示表情      | Lottie、帧动画、GIF、Canvas 动画              | Unity（嵌入 Android）、Three.js WebView |
| **嘴型同步（LipSync）** | 让角色嘴巴跟声音同步    | 分析 TTS 音素 → 动画                        | Rhubarb LipSync、音量阈值驱动             |
| **Avatar（可选）**    | 3D 卡通人物 ／ 数字人 | Unity Avatar、ChatdollKit、Three.js     | 静态 PNG + 动画帧                       |
| **网络通信**          | 和服务器 / 云端模型通信 | Retrofit、OkHttp、WebSocket             | gRPC                               |
| **本地存储**          | 存历史对话/配置      | Room、MMKV、SP                          | LitePal                            |
| **后台常驻服务**        | 常驻录音 / 唤醒线程   | Foreground Service、JobService         | AIDL 进程保活（不建议太激进）                  |
| **系统层适配**         | 读写麦克风权限、保活    | Android 权限管理、Power Manager            | Framework 修改（如定制系统）                |
| **OTA 升级（可选）**    | 模型或素材更新       | 自研 OTA、基于文件的差分升级                      | Firebase OTA（国内不适用）                |
| **硬件交互**（可选）      | 触摸、重力、按钮      | SensorManager、GPIO（JNI）               | N/A                                |
| **渲染性能优化**        | 降低 GPU/CPU 占用 | 硬件加速、SurfaceView、动态图缓存                | NDK 优化、局部刷新                        |

## 核心实现难点

| 模块                | 技术难点             | 详细说明                                                                 |
| ----------------- | ---------------- | -------------------------------------------------------------------- |
| **语音识别（ASR）**     | 离线高准确率、噪声环境适应    | 玩具环境噪声大（孩子说话、背景音乐），离线讯飞 SDK 需要调参、使用回声消除/降噪，否则识别率下降                   |
| **语音合成（TTS）**     | 情绪/语气控制、本地延迟     | 玩具对“情绪共情”有要求，本地 TTS 合成音色自然且延迟低比较难，需要调语速、音量、音色                        |
| **本地轻量 LLM**      | 模型压缩、推理速度        | 小型 Qwen 模型需要量化/剪枝 + NPU 加速，否则推理延迟会影响交互体验                             |
| **云端大模型调用**       | 异步设计、上下文管理       | 网络延迟 + API调用时间不可控，需要设计先用本地模型快速响应 → 云端结果替换机制，保证对话流畅且上下文连续             |
| **表情动画 / avatar** | 实时同步、帧率、动画自然     | 需要表情与语音同步，嘴型、眼睛、表情动作协调；复杂 3D avatar 在 RK3568 GPU 上渲染性能有限，需要优化帧率和渲染方式 |
| **多模态融合**         | 协调语音、表情、对话       | 用户说话 → ASR → LLM → TTS → avatar表情 → 播放音频，整个流水线的时间同步和逻辑顺序设计比较复杂       |
| **安卓系统集成**        | 权限、线程、性能         | 安卓 APK 同时处理麦克风、扬声器、屏幕渲染和网络请求，需要合理线程调度和异步处理，否则容易 ANR 或掉帧              |
| **硬件限制**          | CPU/GPU/NPU/内存瓶颈 | RK3568 或 A133 性能有限，本地模型和动画渲染可能同时占用资源，容易出现卡顿，需要优化推理速度和渲染负载            |
| **多轮上下文管理**       | 对话连贯性            | 玩具需要短期/长期上下文跟踪，实现本地 + 云端对话融合，设计缓存策略和状态管理较复杂                          |
| **离线体验保证**        | 无网状态 fallback    | 当网络不稳定或断网时，需要保证本地轻量模型 +表情动画依然可用，否则玩具就“静音”或没反应                        |
| **开发调试**          | 模块联调复杂           | 多 SDK（讯飞 ASR/TTS + LLM API）+动画渲染 +安卓线程 +网络调用，整体联调难度高，容易出现同步问题        |






























