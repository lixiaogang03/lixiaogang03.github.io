---
layout:     post
title:      T113-S3æ¨¡æ‹Ÿæˆæ‘„åƒå¤´
subtitle:   USB Gadget
date:       2025-05-15
author:     LXG
header-img: img/post-bg-camera.jpg
catalog: true
tags:
    - linux
---

## åŸºæœ¬æ€è·¯

**T113-S3 ä¸»æ¿ç«¯ï¼ˆDeviceï¼‰å……å½“ USB è®¾å¤‡**

* å¯ç”¨ USB Device Controllerï¼ˆUDCï¼‰ï¼›
* åŠ è½½ g_webcam æ¨¡æ‹Ÿ UVC æ‘„åƒå¤´ï¼›
* å°†æ•°æ®æºï¼ˆæ¯”å¦‚æ¥è‡ªæœ¬åœ°æ‘„åƒå¤´æˆ–æ–‡ä»¶ï¼‰é€šè¿‡ v4l2loopback æ³¨å…¥ï¼›
* æœ€ç»ˆé€šè¿‡ USB æä¾›è§†é¢‘æ•°æ®ç»™ä¸»æœºç«¯ï¼ˆHost PC/Android è¯†åˆ«ä¸ºæ‘„åƒå¤´è®¾å¤‡ï¼‰ã€‚

**å®‰å“ä¸»æœºç«¯ï¼ˆHostï¼‰è¯†åˆ«ä¸ºæ‘„åƒå¤´**

* æ’ä¸Š USB åè‡ªåŠ¨è¯†åˆ«ä¸ºæ ‡å‡†æ‘„åƒå¤´

## ç®€åŒ–åçš„æµç¨‹å›¾

```bash

T113-S3:
[Image Source] â†’ /dev/video10 â†’ v4l2loopback â†’ /dev/video0 â†’ g_webcam â†’ USB Gadget

è¿æ¥çº¿:
T113 USB0 (OTG Device) <==> RK3568 USB-Host

RK3568:
é€šè¿‡ USB è¯†åˆ«ä¸º UVC æ‘„åƒå¤´ â†’ /dev/videoX

```

## ç¡®ä¿ USB æ¥å£æ”¯æŒ Device æ¨¡å¼

```bash

sh-4.4# ls /sys/class/udc/
4100000.udc-controller

```

## é…ç½®å†…æ ¸ï¼ˆBuildroot + å¤–éƒ¨å†…æ ¸ï¼‰

```sh

CONFIG_USB_G_WEBCAM=y        # Gadget æ‘„åƒå¤´æ”¯æŒ
CONFIG_USB_LIBCOMPOSITE=y    # å¿…é¡»æ”¯æŒ composite gadget æ¡†æ¶
CONFIG_USB_MUSB_HDRC=y       # å…¨å¿— USB æ§åˆ¶å™¨
CONFIG_USB_MUSB_GADGET=y

```

ä»¥ä¸Šé…ç½®åæ— æ³•è¿›å…¥ä¸²å£ç»ˆç«¯ï¼Œä¿®æ”¹æˆCONFIGFSæ–¹å¼

```sh

# CONFIG_USB_G_WEBCAM=y  ä¸å†éœ€è¦
CONFIG_USB_CONFIGFS_F_UVC=y

```

## CONFIG_USB_G_WEBCAM=y ä¸ configfs è„šæœ¬æ–¹å¼å¯¹æ¯”

| å¯¹æ¯”é¡¹ | å†…æ ¸ç›´æ¥åŠ è½½ï¼ˆg_webcam=yï¼‰ | configfs è„šæœ¬åŠ è½½ï¼ˆæ¨èï¼‰ |
|--------|-----------------------------|----------------------------|
| å¯åŠ¨å®‰å…¨æ€§ | âŒ å®¹æ˜“å¡æ­»ä¸²å£/ç³»ç»Ÿ | âœ… å¯åŠ¨åå†åŠ è½½ï¼Œå®‰å…¨ |
| ä¸²å£å¯ç”¨æ€§ | âŒ å¯èƒ½å¯¼è‡´ ttyS0 å¡æ­»æˆ–æ— è¾“å‡º | âœ… ä¸²å£ä¸ä¼šå—å½±å“ |
| å‚æ•°å¯è°ƒæ€§ï¼ˆåˆ†è¾¨ç‡ã€æè¿°ç¬¦ï¼‰ | âŒ å›ºå®šå‚æ•° | âœ… å¯è‡ªå®šä¹‰åˆ†è¾¨ç‡ã€å¸§ç‡ã€VID/PID ç­‰ |
| è§†é¢‘æºçµæ´»æ€§ | âŒ é»˜è®¤ç”±å†…æ ¸æ§åˆ¶ | âœ… å¯ç»‘å®šä»»æ„ /dev/videoX |
| çƒ­æ’æ‹”æ”¯æŒ | âŒ ä¸æ”¯æŒçƒ­æ’æ‹” | âœ… æ”¯æŒå¸è½½/é‡æ–°ç»‘å®š gadget |
| å¤åˆè®¾å¤‡æ”¯æŒï¼ˆå¦‚ä¸²å£+æ‘„åƒå¤´ï¼‰ | âŒ éœ€è¦é‡æ–°ç¼–è¯‘ gadget é©±åŠ¨ | âœ… æ”¯æŒ gadget å¤šåŠŸèƒ½ç»„åˆ |
| è°ƒè¯•å‹å¥½ç¨‹åº¦ | âŒ ä¸åˆ©äºè°ƒè¯• | âœ… å¯éšæ—¶å¯ç”¨/ç¦ç”¨ï¼Œæ›´çµæ´» |
| é€‚åˆé˜¶æ®µ | å¼€å‘åˆæœŸæµ‹è¯•ç”¨ | âœ… æ¨èç”¨äºé‡äº§æˆ–é«˜çº§å®šåˆ¶åœºæ™¯ |

## configfs é…ç½® USB æ‘„åƒå¤´ Gadget

```sh

#!/bin/bash
set -e

GADGET_DIR=/sys/kernel/config/usb_gadget/g1

mount -t configfs none /sys/kernel/config > /dev/null 2>&1

# 1. åˆ›å»º gadget ç›®å½•
mkdir -p $GADGET_DIR

# 2. è®¾ç½® USBè®¾å¤‡IDå’Œç‰ˆæœ¬
echo 0x1d6b > $GADGET_DIR/idVendor    # Linux Foundation
echo 0x0104 > $GADGET_DIR/idProduct   # Multifunction Composite Gadget
echo 0x0100 > $GADGET_DIR/bcdDevice   # v1.0.0
echo 0x0200 > $GADGET_DIR/bcdUSB      # USB2

# 3. åˆ›å»ºå­—ç¬¦ä¸²ç›®å½•
mkdir -p $GADGET_DIR/strings/0x409
echo "0123456789" > $GADGET_DIR/strings/0x409/serialnumber
echo "MyManufacturer" > $GADGET_DIR/strings/0x409/manufacturer
echo "MyUSBWebcam" > $GADGET_DIR/strings/0x409/product

# 4. åˆ›å»ºé…ç½®
mkdir -p $GADGET_DIR/configs/c.1
echo 120 > $GADGET_DIR/configs/c.1/MaxPower  # æœ€å¤§åŠŸç‡å•ä½mA

# é…ç½®æè¿°å­—ç¬¦ä¸²
mkdir -p $GADGET_DIR/configs/c.1/strings/0x409
echo "UVC Config" > $GADGET_DIR/configs/c.1/strings/0x409/configuration

# 5. æ·»åŠ  UVC åŠŸèƒ½
mkdir -p $GADGET_DIR/functions/uvc.usb0

# å¯é€‰ï¼šè®¾ç½®è§†é¢‘æ ¼å¼ï¼Œåˆ†è¾¨ç‡ï¼Œå¸§ç‡
echo 307200 > $GADGET_DIR/functions/uvc.usb0/streaming_maxpacket  # è®¾ç½®æœ€å¤§åŒ…å¤§å°

# 6. ç»‘å®š UVCåŠŸèƒ½åˆ°é…ç½®
ln -s $GADGET_DIR/functions/uvc.usb0 $GADGET_DIR/configs/c.1/

# 7. ç»‘å®šåˆ° UDC
# ç­‰å¾…è‡³å°‘ä¸€ä¸ª UDC å‡ºç°
while [ ! "$(ls /sys/class/udc 2>/dev/null)" ]; do
    echo "ç­‰å¾… UDC å‡ºç°..."
    sleep 1
done

# è·å–ç¬¬ä¸€ä¸ªå¯ç”¨çš„ UDC åç§°
UDC=$(ls /sys/class/udc | head -n 1)
echo "ä½¿ç”¨ UDC: $UDC"


echo $UDC > $GADGET_DIR/UDC

echo "USB Gadget å¯åŠ¨å®Œæˆï¼Œè®¾å¤‡ä¸Šçº¿"

```

## T113-S3 è‡ªå¸¦çš„/etc/adb_conf.shä¸è™šæ‹Ÿç›¸æœºä¼šå†²çª

**/etc/init.d/rcS**

```sh

/etc/adb_conf.sh start &

```

**adb_conf.sh**

```sh

#!/bin/sh

disable_udc="/etc/.disable_udc"
udc_config=/sys/kernel/config/usb_gadget/g1/UDC

function enable_udc(){
    while [ 1 ];do
        udc=`ls /sys/class/udc 2>/dev/null`
        isudc=`cat $udc_config 2>/dev/null`
        if [ "x$isudc" = "x" ] && [ -f $udc_config ]; then
            echo $udc > $udc_config
        fi
        sleep 1
        if [ -f $disable_udc ];then
            rm $disable_udc
            break
        fi
    done
}

function start_adb(){
    serialnumber=$1
    if [ "x$serialnumber" = "x" ];then
        serialnumber="0402101560"
    fi
    printf "Starting adb "
    # for adbd compatibilities
    mkdir -p /system/
    mkdir -p /system/bin
    if [ ! -f /system/bin/sh ];then
        ln -s /bin/sh /system/bin/sh
    fi

    # config ptmx
    mkdir -p /dev/pts
    mount -t devpts none /dev/pts

    # config adb function
    mount -t configfs none /sys/kernel/config > /dev/null 2>&1
    mkdir -p /sys/kernel/config/usb_gadget/g1
    echo "0x18d1" > /sys/kernel/config/usb_gadget/g1/idVendor
    echo "0x0002" > /sys/kernel/config/usb_gadget/g1/idProduct
    mkdir -p /sys/kernel/config/usb_gadget/g1/strings/0x409
    echo "$serialnumber" > /sys/kernel/config/usb_gadget/g1/strings/0x409/serialnumber
    echo "Google.Inc" > /sys/kernel/config/usb_gadget/g1/strings/0x409/manufacturer
    echo "Configfs ffs gadget" > /sys/kernel/config/usb_gadget/g1/strings/0x409/product
    mkdir -p /sys/kernel/config/usb_gadget/g1/functions/ffs.adb
    mkdir -p /sys/kernel/config/usb_gadget/g1/configs/c.1
    mkdir -p /sys/kernel/config/usb_gadget/g1/configs/c.1/strings/0x409
    echo 0xc0 > /sys/kernel/config/usb_gadget/g1/configs/c.1/bmAttributes
    echo 500 > /sys/kernel/config/usb_gadget/g1/configs/c.1/MaxPower
    ln -s /sys/kernel/config/usb_gadget/g1/functions/ffs.adb/ /sys/kernel/config/usb_gadget/g1/configs/c.1/ffs.adb > /dev/null 2>&1
    mkdir -p /dev/usb-ffs
    mkdir -p /dev/usb-ffs/adb
    if [ "x`ls -A /dev/usb-ffs/adb`" = "x" ];then
        mount -o uid=2000,gid=2000 -t functionfs adb /dev/usb-ffs/adb/
    fi

    # start adbd daemon
    adbd &
    sleep 1

    # enable udc
    #UDC_DEVICE=`find -name "usb_device"`
    #cat $UDC_DEVICE
    cat /sys/bus/platform/drivers/otg\ manager/soc\@3000000\:usbc0\@0/usb_device

    enable_udc &
}

case "$1" in
    start|"")
        otg_role_file="/sys/bus/platform/drivers/otg manager/usbc0/otg_role"
        [ -f "$otg_role_file" ] && otg_role=`cat "$otg_role_file"`
        if ifconfig > /dev/null 2>&1 && [ "x$otg_role" != "xusb_host" ];then
			autotest=/etc/.autotest
            [ -f $autotest ] && serialnumber=`cat $autotest`
	    if [ "x$serialnumber" = "x" ];then
		serialnumber=`cat /proc/cmdline | tr ' ' '\n' | grep 'snum' | awk -F "=" '{print $2}'`
	    fi
            start_adb $serialnumber
        fi
        ;;
    stop)
        printf "Stopping adbd "
        touch $disable_udc
		sleep 2
        killall adbd &
        [ $? -eq 0 ] && echo "OK" || "FAIL"
        ;;
    restart|reload)
        "$0" stop
        "$0" start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

```

## DTS USB é…ç½®

```c

/*
 * usb_port_type: USB æ§åˆ¶å™¨å·¥ä½œæ¨¡å¼
 *     0 - Device æ¨¡å¼ï¼ˆä»æœºï¼‰
 *     1 - Host æ¨¡å¼ï¼ˆä¸»æœºï¼‰
 *     2 - OTG æ¨¡å¼ï¼ˆå¯åˆ‡æ¢ï¼‰
 *
 * usb_detect_type: USB æ’æ‹”æ£€æµ‹ç±»å‹
 *     0 - æ— æ£€æµ‹ï¼ˆå›ºå®šæ¨¡å¼ï¼‰
 *     1 - é€šè¿‡ ID/VBUS GPIO æ£€æµ‹
 *     2 - ä½¿ç”¨ ID + DPDM æ£€æµ‹ï¼ˆéœ€è¦ DP/DM å¼•è„šï¼‰
 *
 * usb_detect_mode: æ£€æµ‹æ–¹å¼
 *     0 - è½®è¯¢ï¼ˆçº¿ç¨‹è½®è¯¢æ–¹å¼ï¼‰
 *     1 - ä¸­æ–­ï¼ˆé€šè¿‡ ID GPIO è§¦å‘ä¸­æ–­ï¼‰
 *
 * usb_id_gpio: OTG ä¸­ ID å¼•è„šå¯¹åº”çš„ GPIOï¼Œç”¨äºåˆ¤æ–­æ’å…¥çš„æ˜¯ä¸»æœºè¿˜æ˜¯è®¾å¤‡
 *
 * usb_det_vbus_gpio: æ£€æµ‹ VBUS ç”µå‹çš„ GPIOï¼ˆæ’å…¥ä¸»æœºæ—¶ä¼šæœ‰ VBUS ä¾›ç”µï¼‰
 *
 * usb_wakeup_suspend:
 *     0 - ä½¿ç”¨ SUPER_STANDBY æ¨¡å¼å”¤é†’
 *     1 - ä½¿ç”¨ USB_STANDBY æ¨¡å¼å”¤é†’ï¼ˆæ›´çœç”µï¼‰
 */

&usbc0 {
	device_type = "usbc0";  // æ§åˆ¶å™¨åç§°ï¼Œå¯é€‰ï¼Œæè¿°æ€§ä¿¡æ¯

	usb_port_type = <0x2>;  // è®¾ç½®ä¸º OTG æ¨¡å¼ï¼ˆæ—¢èƒ½åšä¸»æœºï¼Œä¹Ÿèƒ½åšè®¾å¤‡ï¼‰

	usb_detect_type = <0x1>;  // ä½¿ç”¨ ID/VBUS æ£€æµ‹æ¥å†³å®šæ˜¯ä¸»æœºè¿˜æ˜¯ä»æœºæ¨¡å¼

	usb_detect_mode = <0>;  // é‡‡ç”¨çº¿ç¨‹è½®è¯¢æ–¹å¼æ£€æµ‹ ID çŠ¶æ€ï¼Œé€‚é…èŒƒå›´æ›´å¹¿

	usb_id_gpio = <&pio PE 12 GPIO_ACTIVE_HIGH>;  // ID æ£€æµ‹ä½¿ç”¨ PE12 å¼•è„šï¼ŒGPIO é«˜ç”µå¹³è¡¨ç¤ºâ€œè®¾å¤‡æ¨¡å¼â€

	enable-active-high;  // æŒ‡å®šä¸Šè¿° GPIO ä¸ºé«˜ç”µå¹³æœ‰æ•ˆï¼ˆActive Highï¼‰

	usb_det_vbus_gpio = <&pio PF 6 GPIO_ACTIVE_HIGH>;  // ç”¨ PF6 å¼•è„šæ£€æµ‹ VBUSï¼ˆä¸»æœºæ˜¯å¦æ’å…¥ï¼‰

	usb_wakeup_suspend = <0>;  // è®¾ç½®ä¸º SUPER_STANDBY å”¤é†’æ¨¡å¼ï¼ŒåŠŸè€—ç•¥é«˜ä½†å…¼å®¹æ€§å¥½

	usb_serial_unique = <0>;  // æ˜¯å¦ä½¿ç”¨ CPU ID ä½œä¸ºå”¯ä¸€ USB åºåˆ—å·ã€‚0=å¦ï¼ˆä½¿ç”¨å›ºå®šå­—ç¬¦ä¸²ï¼‰

	usb_serial_number = "20080411";  // è®¾ç½® USB è®¾å¤‡åºåˆ—å·ï¼ˆå›ºå®šå€¼ï¼‰

	rndis_wceis = <1>;  // å¯ç”¨ Windows RNDIS æè¿°ç¬¦æ‰©å±•ï¼Œä¾¿äºä¸ Windows PC å»ºç«‹ç½‘ç»œå…±äº«è¿æ¥

	status = "okay";  // å¯ç”¨æ­¤èŠ‚ç‚¹
};

&ehci0 {
	drvvbus-supply = <&reg_usb1_vbus>;  // USB Host VBUS ç”µæºï¼Œè¿æ¥åˆ°ç”µæºç®¡ç†èŠ¯ç‰‡æˆ–å›ºå®šç”µå‹ä¾›ç”µå™¨ä»¶
};

&ohci0 {
	drvvbus-supply = <&reg_usb1_vbus>;  // ä¸ EHCI ç›¸åŒï¼Œä¸º OHCI æ§åˆ¶å™¨é…ç½®ä¾›ç”µ
};

```


## è¿è¡Œusb_cam.shçš„æŠ¥é”™ä¿¡æ¯

æ‰“å¼€è°ƒè¯•å¼€å…³

```sh

CONFIG_USB_GADGET_DEBUG=y
CONFIG_USB_GADGET_DEBUG_FILES=y
CONFIG_USB_GADGET_DEBUG_FS=y

```

**æŠ¥é”™æ—¥å¿—**

```bash

[    5.601218] udc 4100000.udc-controller: registering UDC driver [g1]
[    5.608443] configfs-gadget gadget: adding 'uvc'/(ptrval) to config 'c'/(ptrval)
[    5.617201] configfs-gadget gadget: uvc: uvc_function_bind() enter
[    5.624401] configfs-gadget gadget: uvc: opts after clamp: interval=1, maxpacket=1024, maxburst=0
[    5.634506] configfs-gadget gadget: uvc: max_packet_mult=1, max_packet_size=1024
[    5.642972] configfs-gadget gadget: uvc: Allocated control EP: ep4-int
[    5.650271] configfs-gadget gadget: uvc: Allocated streaming EP: ep3-iso
[    5.657946] configfs-gadget gadget: uvc: usb strings attached
[    5.664513] configfs-gadget gadget: uvc: Allocated control interface ID: 0
[    5.672312] configfs-gadget gadget: uvc: Allocated streaming interface ID: 1
[    5.680173] configfs-gadget gadget: uvc: uvc_copy_descriptors FS failed: -19
[    5.688218] configfs-gadget gadget: uvc: error handling cleanup
[    5.694947] configfs-gadget gadget: adding 'uvc'/(ptrval) --> -19
[    5.701777] configfs-gadget 4100000.udc-controller: driver->bind() failed: -19
[    5.710091] configfs-gadget 4100000.udc-controller: failed to start g1: -19

```

## æŠ¥é”™ä»£ç ä½ç½®

kernel/linux-5.4/drivers/usb/gadget/udc/core.c

```c

static int udc_bind_to_driver(struct usb_udc *udc, struct usb_gadget_driver *driver)
{
	int ret;

	dev_dbg(&udc->dev, "registering UDC driver [%s]\n",
			driver->function);

	udc->driver = driver;
	udc->dev.driver = &driver->driver;
	udc->gadget->dev.driver = &driver->driver;

	usb_gadget_udc_set_speed(udc, driver->max_speed);

	ret = driver->bind(udc->gadget, driver);
	if (ret)
		goto err1;
	ret = usb_gadget_udc_start(udc);
	if (ret) {
		driver->unbind(udc->gadget);
		goto err1;
	}
	usb_udc_connect_control(udc);

	kobject_uevent(&udc->dev.kobj, KOBJ_CHANGE);
	return 0;
err1:
	if (ret != -EISNAM)
		dev_err(&udc->dev, "failed to start %s: %d\n",
			udc->driver->function, ret);
	udc->driver = NULL;
	udc->dev.driver = NULL;
	udc->gadget->dev.driver = NULL;
	return ret;
}

```

**å¦‚ä½•è¿›ä¸€æ­¥åˆ†æ**

```bash

echo <UDC> > UDC
        â†“
usb_gadget_bind_driver()                             â† udc/core.c
        â†“
udc_bind_to_driver()                                 â† udc/core.c
        â†“
driver->bind(udc->gadget, driver)                    â† composite_driver.bind æŒ‡å‘ composite_bind
        â†“
composite_bind()                                     â† composite.c
        â†“
usb_add_config()                                     â† composite.c
        â†“
config->bind()                                       â† å¯¹åº” configfs ä¸­çš„ gadget é…ç½®å‡½æ•°
        â†“
f->bind() = uvc_function_bind()                      â† f_uvc.c
        â†“
æ³¨å†Œ V4L2ã€åˆ†é… descriptorsã€epã€interface id ç­‰

```

## ä»£ç è°ƒç”¨é“¾

```bash

ç”¨æˆ·ç©ºé—´ï¼ˆShell è„šæœ¬ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mkdir /sys/kernel/config/usb_gadget/g1      â”‚
â”‚  echo idVendor/idProduct/bcdUSB              â”‚
â”‚  mkdir functions/uvc.usb0                    â”‚
â”‚  ln -s functions/uvc.usb0 â†’ configs/c.1/     â”‚
â”‚  echo <UDC> > UDC                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
å†…æ ¸ ConfigFS å¤„ç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  drivers/usb/gadget/function/f_uvc.c         â”‚
â”‚  â”œâ”€ uvc_alloc_inst()                         â”‚
â”‚  â””â”€ uvc_alloc()                              â”‚
â”‚     ï¼ˆåˆ›å»º function ç»“æ„ä½“ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
ç¬¦å·é“¾æ¥è§¦å‘ Gadget Function æ’å…¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ drivers/usb/gadget/composite.c              â”‚
â”‚ â””â”€ composite_bind()                         â”‚
â”‚     â””â”€ f->bind() = uvc_function_bind()      â”‚
â”‚         â†³ åˆå§‹åŒ– UVC åŠŸèƒ½ï¼Œæ³¨å†Œ V4L2        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
echo <UDC> > UDC æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kernel/linux-5.4/drivers/usb/gadget/udc/core.câ”‚
â”‚ â””â”€ usb_gadget_bind_driver()                  â”‚
â”‚     â””â”€ udc_bind_to_driver()                  â”‚
â”‚         â†³ è°ƒç”¨ composite_driver->bind()      â”‚
â”‚            ï¼ˆå³ä¸Šé¢çš„ composite_bindï¼‰       â”‚
â”‚         â†³ usb_gadget_udc_start()            â”‚
â”‚         â†³ usb_udc_connect_control()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
ğŸ”” æˆåŠŸåï¼šfunctionï¼ˆuvcï¼‰æ³¨å†Œå®Œæ¯•ï¼Œç³»ç»Ÿå‡ºç° `/dev/video*`


```






















