---
layout:     post
title:      RK3568 USB相机报错问题
subtitle:   UVC
date:       2025-10-22
author:     LXG
header-img: img/post-bg-camera.jpg
catalog: true
tags:
    - camera
---

## 测试 Demo

[AndroidUSBCamera](https://github.com/jiangdongguo/AndroidUSBCamera)

**打开相机的参数**

```kotlin

    override fun getCameraRequest(): CameraRequest {
        return CameraRequest.Builder()
            .setPreviewWidth(1920)
            .setPreviewHeight(1080)
            .setRenderMode(CameraRequest.RenderMode.NORMAL)//返回NV21格式
            .setDefaultRotateType(RotateType.ANGLE_0)//旋转角度
            .setExposureNum(11)
            .setPreviewFps(10)
            .setExposureMode(CameraRequest.ExposureMode.EXPOSURE_MANUAL)
            .setPreviewFormat(CameraRequest.PreviewFormat.FORMAT_MJPEG)
            .setAspectRatioShow(true)
            .setCaptureRawImage(false)
            .setRawPreviewData(false)
            .create()
    }


```

## 报错日志

```bash

2025-10-22 15:43:33.619     0-0     usb 2-1                 kernel                               W  usbfs: process 2572 (USBMonitor) did not claim interface 0 before use
2025-10-22 15:43:33.660     0-0     usb 2-1                 kernel                               W  usbfs: process 2576 (camera-17611190) did not claim interface 0 before use
2025-10-22 15:43:34.020     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:43:34.099  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.100  2516-2578  libUVCCamera            com.jiangdg.ausbc                    W  [2578*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.131  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.159  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.185  2516-2578  ion                     com.jiangdg.ausbc                    E  ioctl c0044901 failed with code -1: Inappropriate ioctl for device
2025-10-22 15:43:34.191  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.199  2516-2578  libUVCCamera            com.jiangdg.ausbc                    W  [2578*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.279  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.375  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:37.755  2516-2579  libUVCCamera            com.jiangdg.ausbc                    W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:40.648     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:45:33.056     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:45:37.736     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:49:00.220     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:49:35.812     0-0     usb 2-1                 kernel                               W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81

```

## 日志解析-chatgpt

```bash

2025-10-22 15:43:33.619     0-0     usb 2-1  kernel  W  usbfs: process 2572 (USBMonitor) did not claim interface 0 before use
# USBMonitor进程访问UVC设备接口0之前没有调用claim接口。
# 警告级别，不会致命，但说明USB接口使用不够规范，可能导致后续数据传输异常。

2025-10-22 15:43:33.660     0-0     usb 2-1  kernel  W  usbfs: process 2576 (camera-17611190) did not claim interface 0 before use
# camera进程访问UVC设备接口0之前也没有claim。
# 与上一条类似，提示USB访问逻辑不够严格。

2025-10-22 15:43:34.020     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
# USB端点0x81发生STALL（数据传输中断），应用调用CLEAR_HALT尝试恢复。
# 多数出现在高带宽数据传输或长时间采集时，说明USB压力较大。

2025-10-22 15:43:34.099  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.100  2516-2578  libUVCCamera  com.jiangdg.ausbc  W  [2578*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.131  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.159  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
# libUVCCamera为每一帧分配新的缓冲区。
# 长时间高分辨率预览容易导致ION/CMA内存压力累积。

2025-10-22 15:43:34.185  2516-2578  ion  com.jiangdg.ausbc  E  ioctl c0044901 failed with code -1: Inappropriate ioctl for device
# 核心错误，ION缓冲区分配或操作失败。
# 原因可能：
#   1. 内核IOCTL命令不匹配或权限不足
#   2. ION heap或CMA内存不足
# 这个错误会直接影响UVC预览稳定性，可能导致帧丢失或应用崩溃。

2025-10-22 15:43:34.191  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.199  2516-2578  libUVCCamera  com.jiangdg.ausbc  W  [2578*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.279  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
2025-10-22 15:43:34.375  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
# 持续分配缓冲区，说明内存压力累积且没有复用缓冲池。
# 长时间运行可能触发OOM或ION失败。

2025-10-22 15:43:37.755  2516-2579  libUVCCamera  com.jiangdg.ausbc  W  [2579*UVCPreview.cpp:128:get_frame]:allocate new frame
# 继续分配新帧缓冲，长时间采集仍在增加内存压力。

2025-10-22 15:43:40.648     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:45:33.056     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:45:37.736     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:49:00.220     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
2025-10-22 15:49:35.812     0-0     usb 2-1  kernel  W  Process 2577 (camera-17611190) called USBDEVFS_CLEAR_HALT for active endpoint 0x81
# USB端点0x81持续STALL并清除。
# 频繁出现表示USB带宽不足或者主机/摄像头驱动无法稳定传输大量数据。

```


























