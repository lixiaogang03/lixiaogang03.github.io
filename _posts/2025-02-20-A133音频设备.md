---
layout:     post
title:      A133 éŸ³é¢‘è®¾å¤‡
subtitle:   android 10
date:       2025-02-25
author:     LXG
header-img: img/post-bg-smart_phone.jpg
catalog: true
tags:
    - audio
---

[éŸ³é¢‘-AOSP](https://source.android.google.cn/docs/core/audio?hl=zh-cn)

[Android Framework éŸ³é¢‘å­ç³»ç»Ÿï¼ˆ02ï¼‰éŸ³é¢‘ç³»ç»Ÿæ¡†æ¶](https://blog.csdn.net/vviccc/article/details/105265359)

## AOSP éŸ³é¢‘æ¶æ„

![ape_fwk_audio](/images/android/audio/ape_fwk_audio.png)

## æŸ¥çœ‹éŸ³é¢‘ç¡¬ä»¶å‘½ä»¤

```bash

WIFBY:/ $ cat proc/asound/cards                                                                                                                                                                    
 0 [sun50iw10codec ]: sun50iw10-codec - sun50iw10-codec
                      sun50iw10-codec
 1 [CAMERA         ]: USB-Audio - WN Full HD CAMERA
                      WN-ZW-220419 WN Full HD CAMERA at usb-sunxi-ehci-1.2, high speed

```

| è®¾å¤‡ç´¢å¼• | è®¾å¤‡åç§°               | è®¾å¤‡ç±»å‹          | è¿æ¥æ–¹å¼              | å¤‡æ³¨                     |
|---------|----------------------|---------------|-----------------|----------------------|
| 0       | sun50iw10-codec      | æ¿è½½éŸ³é¢‘è®¾å¤‡      | SoC å†…ç½®            | å¯èƒ½æ˜¯æ‰¬å£°å™¨æˆ– 3.5mm æ¥å£ |
| 1       | WN Full HD CAMERA    | USB éŸ³é¢‘è®¾å¤‡      | USBï¼ˆusb-sunxi-ehci-1.2ï¼‰ | æ‘„åƒå¤´è‡ªå¸¦éº¦å…‹é£        |

## A133 éŸ³é¢‘æ¡†æ¶

![a133_audio](/images/android/audio/a133_audio.png)

åœ¨ A133 ä¸­ï¼Œå­˜åœ¨ 7 ä¸ªéŸ³é¢‘è®¾å¤‡ï¼Œåˆ†åˆ«æ˜¯ï¼š

![a133_audio_hardware](/images/android/audio/a133_audio_hardware.png)

## Linux ALSA

ALSAï¼ˆAdvanced Linux Sound Architectureï¼Œé«˜çº§ Linux å£°éŸ³æ¶æ„ï¼‰ æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€å¥—éŸ³é¢‘é©±åŠ¨æ¡†æ¶ï¼Œç”¨äºç®¡ç†éŸ³é¢‘è®¾å¤‡ï¼ˆå£°å¡ã€éº¦å…‹é£ã€USB éŸ³é¢‘è®¾å¤‡ç­‰

ASoCï¼ˆALSA System on Chipï¼‰ æ˜¯ ALSAï¼ˆLinux å£°éŸ³æ¶æ„ï¼‰ä¸“é—¨ä¸º SoC è®¾è®¡çš„éŸ³é¢‘å­ç³»ç»Ÿï¼Œç”¨äºç®¡ç†åµŒå…¥å¼ç³»ç»Ÿï¼ˆå¦‚å¼€å‘æ¿ã€æ™ºèƒ½è®¾å¤‡ï¼‰ä¸Šçš„éŸ³é¢‘è®¾å¤‡ã€‚

**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ ASoCï¼Ÿ**

æ™®é€š PC çš„å£°å¡ä¸€èˆ¬æ˜¯**æ ‡å‡†åŒ–çš„**ï¼ˆå¦‚ Intel HDAã€USB å£°å¡ï¼‰ï¼ŒALSA å¯ä»¥ç›´æ¥æ”¯æŒã€‚ä½†åµŒå…¥å¼ç³»ç»Ÿçš„éŸ³é¢‘ç¡¬ä»¶**åƒå·®ä¸‡åˆ«**ï¼Œéœ€è¦æ›´çµæ´»çš„æ¶æ„æ¥ç®¡ç†ã€‚å› æ­¤ï¼ŒASoC ä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **ä¸åŒ SoC èŠ¯ç‰‡çš„éŸ³é¢‘æ§åˆ¶é€»è¾‘ä¸åŒ**ï¼ˆå¦‚ Allwinnerã€Rockchipã€Qualcommã€Amlogicï¼‰
2. **éŸ³é¢‘ç¼–è§£ç å™¨ï¼ˆCodecï¼‰ç§ç±»ç¹å¤š**ï¼ˆä¸åŒå‚å•†ä½¿ç”¨ä¸åŒçš„ DAC/ADC èŠ¯ç‰‡ï¼‰
3. **å¼€å‘æ¿çš„éŸ³é¢‘æ¶æ„å¤æ‚**ï¼ˆå¯èƒ½æœ‰å¤šä¸ª I2S æ¥å£ã€å¤šä¸ªéŸ³é¢‘é€šè·¯ï¼‰
4. **é™ä½é©±åŠ¨ä»£ç é‡å¤**ï¼Œæ–¹ä¾¿ç§»æ¤å’Œç»´æŠ¤


**ğŸ”¹ ASoC ç»“æ„**
ASoC æŠŠ SoC çš„éŸ³é¢‘ç³»ç»Ÿæ‹†åˆ†æˆ**ä¸‰å¤§éƒ¨åˆ†**ï¼Œè¿™æ ·æ›´æ˜“äºé€‚é…ä¸åŒç¡¬ä»¶ï¼š

| ç»„ä»¶ | ä½œç”¨ | ä¾‹å­ |
|------|------|------|
| **Codec é©±åŠ¨** | è´Ÿè´£ç®¡ç† **éŸ³é¢‘ç¼–è§£ç èŠ¯ç‰‡**ï¼ˆDAC/ADCï¼‰ | WM8960ã€ES8316ã€RT5645 |
| **Platform é©±åŠ¨** | è´Ÿè´£ SoC çš„ **I2Sã€DMA ä¼ è¾“** | Allwinner ASoCã€Rockchip I2S |
| **Machine é©±åŠ¨** | æŠŠ **Codec å’Œ Platform è¿æ¥èµ·æ¥**ï¼Œå®šä¹‰éŸ³é¢‘è·¯ç”± | å¼€å‘æ¿çš„éŸ³é¢‘æ‹“æ‰‘ï¼Œæ¯”å¦‚æ‰¬å£°å™¨è¿å“ªä¸ªæ¥å£ |


## A133 éŸ³é¢‘æ¥å£å¯¹æ¯”

| **æ¥å£**        | **ç”¨é€”**                | **ç‰¹ç‚¹**                                      | **é€‚ç”¨åœºæ™¯**                     |
|----------------|------------------------|----------------------------------------------|----------------------------------|
| **I2S**       | å¤–éƒ¨ Codec / DSP       | æ”¯æŒ **192kHz é‡‡æ ·ç‡ã€TDMã€å¤šé€šé“ä¼ è¾“**     | **é«˜è´¨é‡éŸ³é¢‘æ’­æ”¾ã€HiFi è®¾å¤‡**    |
| **PCM**       | è¯­éŸ³é€šè®¯               | å…¼å®¹ **VoIP / è“ç‰™è¯­éŸ³**ï¼Œæ”¯æŒçŸ­å¸§/é•¿å¸§æ¨¡å¼ | **è“ç‰™éŸ³é¢‘ã€å¯¹è®²ç³»ç»Ÿ**          |
| **DMIC**      | æ•°å­—éº¦å…‹é£æ¥å£         | **åŒé€šé“ PDM**ï¼Œç›´è¿ MEMS æ•°å­—éº¦å…‹é£       | **AI è¯­éŸ³åŠ©æ‰‹ã€é™å™ªæ‹¾éŸ³**        |
| **AUDIO CODEC** | å†…éƒ¨éŸ³é¢‘ç¼–è§£ç å™¨       | å†…ç½® **DAC/ADC**ï¼Œç›´é©±è€³æœº/æ‰¬å£°å™¨          | **åŸºç¡€éŸ³é¢‘æ’­æ”¾ã€å½•éŸ³**           |

## éŸ³é¢‘ç³»ç»Ÿåº•å±‚è®¾å¤‡èŠ‚ç‚¹

```bash

WIFBY:/ $ ls dev/snd/
controlC0 controlC1 pcmC0D0c pcmC0D0p pcmC1D0c timer

WIFBY:/ $ cat /proc/asound/pcm
00-00: SUNXI-CODEC sun50iw10codec-0 :  : playback 1 : capture 1
01-00: USB Audio : USB Audio : capture 1

```

| **è®¾å¤‡æ–‡ä»¶**  | **å«ä¹‰** |
|--------------|---------|
| `controlC0`  | **æ§åˆ¶è®¾å¤‡ 0**ï¼ˆç”¨äºæ§åˆ¶éŸ³é¢‘è®¾å¤‡ï¼Œå¦‚ mixer è®¾ç½®ï¼‰ |
| `controlC1`  | **æ§åˆ¶è®¾å¤‡ 1**ï¼ˆå¦‚æœæœ‰å¤šä¸ªå£°å¡ï¼Œæ¯ä¸ªå£°å¡æœ‰è‡ªå·±çš„ control è®¾å¤‡ï¼‰ |
| `pcmC0D0c`   | **PCM è®¾å¤‡ï¼ˆCard 0, Device 0, Captureï¼‰**ï¼Œè¡¨ç¤º**éŸ³é¢‘è¾“å…¥ï¼ˆå½•éŸ³ï¼‰** |
| `pcmC0D0p`   | **PCM è®¾å¤‡ï¼ˆCard 0, Device 0, Playbackï¼‰**ï¼Œè¡¨ç¤º**éŸ³é¢‘è¾“å‡ºï¼ˆæ’­æ”¾ï¼‰** |
| `pcmC1D0c`   | **PCM è®¾å¤‡ï¼ˆCard 1, Device 0, Captureï¼‰**ï¼Œè¡¨ç¤º**ç¬¬äºŒå¼ å£°å¡çš„å½•éŸ³è®¾å¤‡** |
| `timer`      | **éŸ³é¢‘æ—¶é—´åŒæ­¥ç›¸å…³è®¾å¤‡** |


## dumpsys media.audio_policy

RK3568è¯†åˆ«åˆ°äº†USB-Audio - WN Full HD CAMERA

å…¨å¿—A133æ²¡æœ‰è¯†åˆ«åˆ°

```txt
- Available input devices:
  Device 3:
  - id:  9
  - tag name: USB-Audio - WN Full HD CAMERA
  - type: AUDIO_DEVICE_IN_USB_DEVICE                      
  - supported encapsulation modes: 0  - supported encapsulation metadata types: 0  - address: card=2;device=0;                
  - name: USB-Audio - WN Full HD CAMERA
  - Profiles:
      Profile 0:[dynamic format]
          - format: AUDIO_FORMAT_PCM_16_BIT
          - sampling rates:8000, 16000, 44100, 48000
          - channel masks:0x000c, 0x0010, 0x80000001
  Device 4:
  - id:  6
  - tag name: Built-In Mic
  - type: AUDIO_DEVICE_IN_BUILTIN_MIC                     
  - supported encapsulation modes: 0  - supported encapsulation metadata types: 0  - address: bottom                          
  - Profiles:
      Profile 0:[dynamic format][dynamic channels][dynamic rates]
      Profile 1:
          - format: AUDIO_FORMAT_PCM_16_BIT
          - sampling rates:8000, 11025, 12000, 16000, 22050, 24000, 32000, 44100, 48000
          - channel masks:0x000c, 0x0010

```

## åˆ†æ

frameworks/av/services/audiopolicy/managerdefault/AudioPolicyManager.cpp

```cpp


AudioPolicyManager::AudioPolicyManager(AudioPolicyClientInterface *clientInterface)
        : AudioPolicyManager(clientInterface, false /*forTesting*/)
{
    loadConfig();
    initialize();
}


void AudioPolicyManager::loadConfig() {
    if (deserializeAudioPolicyXmlConfig(getConfig()) != NO_ERROR) {
        ALOGE("could not load audio policy configuration file, setting defaults");
        getConfig().setDefault();
    }
}

status_t AudioPolicyManager::initialize() {
     // -----------------------------------------

    // mAvailableOutputDevices and mAvailableInputDevices now contain all attached devices
    // open all output streams needed to access attached devices
    for (const auto& hwModule : mHwModulesAll) {
        ALOGI("Processing hardware module: %s", hwModule->getName());  // æ‰“å°æ­£åœ¨å¤„ç†çš„ç¡¬ä»¶æ¨¡å—åç§°

        // æ‰“å°å½“å‰ç¡¬ä»¶æ¨¡å—çš„å¯ç”¨è¾“å‡ºå’Œè¾“å…¥è®¾å¤‡ä¿¡æ¯
        ALOGI("Available input devices for module %s: %s", hwModule->getName(), mAvailableInputDevices.toString().c_str());
        ALOGI("Available output devices for module %s: %s", hwModule->getName(), mAvailableOutputDevices.toString().c_str());

        hwModule->setHandle(mpClientInterface->loadHwModule(hwModule->getName()));
        if (hwModule->getHandle() == AUDIO_MODULE_HANDLE_NONE) {
            ALOGW("could not open HW module %s", hwModule->getName());
            continue;
        }
        mHwModules.push_back(hwModule);
        // open all output streams needed to access attached devices
        // except for direct output streams that are only opened when they are actually
        // required by an app.
        // This also validates mAvailableOutputDevices list
        for (const auto& outProfile : hwModule->getOutputProfiles()) {
             //--------------------------------------------
        }
        // open input streams needed to access attached devices to validate
        // mAvailableInputDevices list
        for (const auto& inProfile : hwModule->getInputProfiles()) {
            if (!inProfile->canOpenNewIo()) {
                ALOGE("Invalid Input profile max open count %u for profile %s",
                      inProfile->maxOpenCount, inProfile->getTagName().c_str());
                continue;
            }
            if (!inProfile->hasSupportedDevices()) {
                ALOGW("Input profile contains no device on module %s", hwModule->getName());
                continue;
            }
            // chose first device present in profile's SupportedDevices also part of
            // available input devices
            const DeviceVector &supportedDevices = inProfile->getSupportedDevices();

            ALOGI("Supported devices for profile %s: %s", inProfile->getTagName().c_str(), supportedDevices.toString().c_str());
            DeviceVector availProfileDevices = supportedDevices.filter(mAvailableInputDevices);
            // æ‰“å°ç­›é€‰åçš„å¯ç”¨è®¾å¤‡åˆ—è¡¨
            ALOGI("Available input devices after filter: %s", availProfileDevices.toString().c_str());
            if (availProfileDevices.isEmpty()) {
                ALOGE("%s: Input device list is empty!", __FUNCTION__);
                continue;
            }

            // --------------------------------------------------
        }
    }

    //----------------------------------------------------------

}

```

**æ—¥å¿—æ‰“å°**

```txt


// åœ¨ Android éŸ³é¢‘ç³»ç»Ÿä¸­ï¼Œprimary æ˜¯ä¸»è¦çš„éŸ³é¢‘ç¡¬ä»¶æ¨¡å—ï¼Œè´Ÿè´£å¤„ç† ä¸»å£°å¡ï¼ˆmain sound cardï¼‰ çš„éŸ³é¢‘è¾“å…¥/è¾“å‡ºã€‚
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: primary
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module primary: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module primary: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile primary input: {type:0x80000004,@:;type:0x80000010,@:;type:0x80000008,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: {type:0x80000004,@:}
APM_AudioPolicyManager  pid-2137                             W  Input profile contains no device on module primary

// A2DPï¼ˆAdvanced Audio Distribution Profileï¼‰æ˜¯ è“ç‰™éŸ³é¢‘ä¼ è¾“åè®®ï¼Œç”¨äº è“ç‰™éŸ³ç®±ã€è€³æœºã€è½¦è½½éŸ³å“ç­‰éŸ³é¢‘è¾“å‡ºè®¾å¤‡ã€‚
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: a2dp
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module a2dp: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module a2dp: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile a2dp input: {type:0x80020000,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: AUDIO_DEVICE_NONE
APM_AudioPolicyManager  pid-2137                             E  initialize: Input device list is empty!



APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: usb
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module usb: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module usb: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile usb_device input: {type:0x80001000,@:;type:0x82000000,@:}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: AUDIO_DEVICE_NONE
APM_AudioPolicyManager  pid-2137                             E  initialize: Input device list is empty!


// r_submixï¼ˆRemote Submixï¼‰æ˜¯ Android çš„ è™šæ‹ŸéŸ³é¢‘è®¾å¤‡
APM_AudioPolicyManager  pid-2137                             I  Processing hardware module: r_submix
APM_AudioPolicyManager  pid-2137                             I  Available input devices for module r_submix: {type:0x80000004,@:;type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available output devices for module r_submix: {type:0x2,@:}
APM_AudioPolicyManager  pid-2137                             I  Supported devices for profile r_submix input: {type:0x80000100,@:0}
APM_AudioPolicyManager  pid-2137                             I  Available input devices after filter: {type:0x80000100,@:0}


```

**è®¾å¤‡ç±»å‹å®šä¹‰**

./system/media/audio/include/system/audio-base.h

```c

enum {

    AUDIO_DEVICE_IN_BUILTIN_MIC                = 0x80000004u, // BIT_IN | 0x4
    AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET      = 0x80000008u, // BIT_IN | 0x8
    AUDIO_DEVICE_IN_WIRED_HEADSET              = 0x80000010u, // BIT_IN | 0x10
    AUDIO_DEVICE_IN_REMOTE_SUBMIX              = 0x80000100u, // BIT_IN | 0x100
    AUDIO_DEVICE_IN_USB_DEVICE                 = 0x80001000u, // BIT_IN | 0x1000
}

```

**åˆ†æ**

æœªè¯†åˆ«åˆ° AUDIO_DEVICE_IN_USB_DEVICE(0x80001000u) è®¾å¤‡


















