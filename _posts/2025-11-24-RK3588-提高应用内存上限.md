---
layout:     post
title:      RK3588 提高应用内存上限
subtitle:   android 12
date:       2025-11-24
author:     LXG
header-img: img/post-bg-android.jpg
catalog: true
tags:
    - rk3588
---

## 应用内存过大导致OOM

![rk3588_app_memory](/images/rockchip/rk3588/rk3588_app_memory.png)

private_other 内存过大导致OOM

App 主要跑人工智能模型（大模型权重 / 大量 mmap / GPU/NPU buffer / native heap）

目标是 降低 private_other（mmap/anon/ion）占用、避免 OOM、并提升模型加载与推理稳定性

## 内存图像

cat proc/meminfo

```sh

MemTotal: 7848664 kB
MemFree: 4311224 kB
MemAvailable: 5675652 kB
Buffers: 3656 kB
Cached: 2121248 kB
SwapCached: 0 kB
Active: 301268 kB
Inactive: 1825472 kB
Active(anon): 3476 kB
Inactive(anon): 745896 kB
Active(file): 297792 kB
Inactive(file): 1079576 kB
Unevictable: 738256 kB
Mlocked: 116116 kB
SwapTotal: 3924328 kB
SwapFree: 3924328 kB
Dirty: 356 kB
Writeback: 0 kB
AnonPages: 740152 kB
Mapped: 1232804 kB    // 此项很大
Shmem: 632164 kB
KReclaimable: 95560 kB
Slab: 169460 kB
SReclaimable: 62016 kB
SUnreclaim: 107444 kB
KernelStack: 18992 kB
ShadowCallStack: 4780 kB
PageTables: 43052 kB
NFS_Unstable: 0 kB
Bounce: 0 kB
WritebackTmp: 0 kB
CommitLimit: 7848660 kB
Committed_AS: 50405152 kB
VmallocTotal: 262930368 kB
VmallocUsed: 53384 kB
VmallocChunk: 0 kB
Percpu: 7648 kB
CmaTotal: 131072 kB
CmaAllocated: 4160 kB
CmaReleased: 126912 kB
CmaFree: 126912 kB

```

OOM 根本原因：

* App private_other 占用很高 → 大量 mmap/anonymouse mapping
* Mapped 1.18 GB + Shmem 617 MB → 总地址空间分布碎片化
* Linux max_map_count=65530 限制 → mmap 太多会导致 ENOMEM

## sys.lmk.minfree_levels

这个参数控制 lmkd 在不同内存压力下会杀死哪些优先级的进程

```bash

[sys.lmk.minfree_levels]: [18432:0,23040:100,27648:200,32256:250,55296:900,80640:950]

18432:0        → 可用 RAM < 72 MB   → 允许杀 adj ≥ 0（实际不会杀前台）
23040:100      → 可用 RAM < 90 MB   → 杀 adj ≥ 100 的进程
27648:200      → 可用 RAM < 108 MB  → 杀 adj ≥ 200
32256:250      → 可用 RAM < 126 MB  → 杀 adj ≥ 250
55296:900      → 可用 RAM < 216 MB  → 杀 adj ≥ 900
80640:950      → 可用 RAM < 315 MB  → 杀 adj ≥ 950（缓存最弱进程）

```

设备是RK3588 8G 内存, 可用内存还有很多，而且应用是前台应用，因此不太可能是sys.lmk.minfree_levels触发导致的OOM

## 可能原因

你的 AI 应用超过了 Android 对单进程的最大内存限制，而不是系统整体内存不足

单个应用最多只能用约 3GB 左右的虚拟地址空间（64-bit 条件下）

| 类型                       | 默认值 (64-bit)                                |
| ------------------------ | ------------------------------------------- |
| **Java 堆**               | maxMemory() 约 512MB～1.5GB（取决于 dalvik props） |
| **native heap (malloc)** | 可达 3GB，但受 ASLR & VMA 限制                     |
| **private_other（mmap）**  | 多时容易导致 address-space OOM                    |

private_other 多通常说明你大量使用 mmap 加载模型。

**为什么你 private_other 很高却 OOM？**

因为 mmap 数量过多 → VMA 数过多 → 触发 OOM：

* Android 和 Linux 默认 max_map_count = 65530
* 大模型（如 500MB+），如果分成几百个文件页映射，会很容易接近极限

## 解决方案-永久扩大进程 mmap 限制

device/rockchip/common/init.rk3588.rc

```bash

write /proc/sys/vm/max_map_count 262144

```








